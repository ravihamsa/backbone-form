<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Base Â· Bootstrap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Backbone Form</title>
    <script type="text/javascript" src="libs/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="libs/handlebars.js"></script>
    <script type="text/javascript" src="libs/underscore.js"></script>
    <script type="text/javascript" src="libs/backbone.js"></script>
    <script type="text/javascript" src="src/app.js"></script>
    <script type="text/javascript" src="src/base.js"></script>
    <script type="text/javascript" src="src/form.js"></script>
    <link rel="stylesheet" href="libs/bootstrap/css/bootstrap.css"/>
</head>
<body>

<script type="text/x-handlebars-template" id="inputView">
    <div class="control-group">
        <label class="control-label">
            {{elementLabel this}}
        </label>

        <div class="controls">
            <input type="{{type}}" name="{{name}}" value="{{value}}" class="el-{{name}}"/>
            <span class="help-inline"></span>
        </div>
    </div>
</script>
<script type="text/x-handlebars-template" id="textAreaView">
    <div class="control-group">
        <label class="control-label">
            {{elementLabel this}}
        </label>

        <div class="controls">
            <textarea type="{{type}}" name="{{name}}" class="el-{{name}}">{{value}}</textarea>
            <span class="help-inline"></span>
        </div>
    </div>
</script>

<script type="text/x-handlebars-template" id="radioListView">
    <div class="control-group">
        <label class="control-label">
            {{elementLabel this}}
        </label>

        <div class="controls">
            {{#each options}}
            <label class="radio inline">
                <input type="radio" name="{{../name}}" value="{{id}}" class="el-{{name}}"/>{{name}}
            </label>
            {{/each}}
            <span class="help-inline"></span>
        </div>
    </div>
</script>

<script type="text/x-handlebars-template" id="selectView">
    <div class="control-group">
        <label class="control-label">
            {{elementLabel this}}
        </label>

        <div class="controls">
            <select name="{{name}}" class="el-{{name}}">
                {{#each options}}
                <option value="{{id}}">{{name}}</option>
                {{/each}}
            </select>
            <span class="help-inline"></span>
        </div>
    </div>
</script>

<script type="text/x-handlebars-template" id="checkListView">
    <div class="control-group">
        <label class="control-label">
            {{elementLabel this}}
        </label>

        <div class="controls">
            {{#each options}}
            <label class="checkbox inline">
                <input type="checkbox" name="{{id}}" value="{{id}}" class="el-{{name}}"/>{{name}}
            </label>
            {{/each}}
            <span class="help-inline"></span>
        </div>
    </div>
</script>
<script type="text/x-handlebars-template" id="trackingPickerView">
    <div class="control-group">
        <label class="control-label">
            {{elementLabel this}}
        </label>

        <div class="controls">
            {{#ifEqual value.type 'impression'}}
            <select>
                <option value="url" selected="selected">URL</option>
                <option value="script">Script</option>
            </select>
            {{else}}
            <select style="display:none">
                <option value="url" selected="selected">URL</option>
            </select>
            {{/ifEqual}}
            <textarea>{{value.value}}</textarea>
            <span class="help-inline"></span>
        </div>
    </div>
</script>

<script type="text/x-handlebars-template" id="trackingCodeView">
    <div class="control-group">
        <label class="control-label">

        </label>

        <div class="controls">
           <div>
            <label class="checkbox inline">
                <input type="checkbox" name="isTracking" /> Enable Tracking
            </label>
           </div>
            <div class="trackingDetails"  style="display:none">
                <input type="text" value="{{value}}"/>
            </div>
            <span class="help-inline"></span>
        </div>
    </div>
</script>

<div id="container">

</div>

<div id="container2">

</div>


<script type="text/javascript">

    var TrackingPickerView = ElementView.extend({
        events:{
            'change select':'updateValue',
            'blur textarea':'updateValue'
        },
        template:'trackingPickerView',
        valueFunction:function(){
            return {
                trackingType:this.$('select').val(),
                value:this.$('textarea').val(),
                type:this.model.get('type')
            }
        }
    });


    var TrackingCodeView =  ElementView.extend({
        events:{
            'blur input':'updateValue',
            'change input:checkbox':'updateActive'
        },
        template:'trackingCodeView',
        valueFunction:function(){
            var el = this.$('.trackingDetails input');
            return el.val();
        },
        valueChangeHandler:function(value){

            var el = this.$('.trackingDetails input');
            el.val(value);

            var isTracking = $.trim(value) !== '';

            this.model.set('active', isTracking);

            var chkbox = this.$('input[name=isTracking]');
            chkbox.each(function(){
                this.checked = isTracking
            })



        },
        updateActive:function(){
            var chkbox = this.$('input[name=isTracking]');
            this.model.set('active',chkbox.is(':checked'));
        },
        activeChangeHandler:function(value){
            console.log(this.$('.trackingDetails'), value);
            this.$('.trackingDetails').toggle(value);
        }
    })

    var coll = new ElementCollection([
        {name: 'adType', type: 'select', value: '1', options: [
            {id: 1, name: 'Text Ad'},
            {id: 2, name: 'Banner Ad'},
            {id: 3, name: 'Banner URL'},
            {id: 4, name: 'Rich Media Ad'}
        ]},
        {name: 'adName', validationRules: [
            {expr: 'req'},
            {expr: 'maxlen', length: 40}
        ]},
        {name: 'adText', validationRules: [
            {expr: 'req'},
            {expr: 'maxlen', length: 40}
        ], activeRules: [
            {expr: 'eq', element: 'adType', value: '1'}
        ]},
        {name: 'altText', activeRules: [
            {expr: 'eq', element: 'adType', value: '2'}
        ]},
        {name: 'banner', activeRules: [
            {expr: 'eq', element: 'adType', value: '2'}
        ]},
        {name: 'bannerURL', activeRules: [
            {expr: 'eq', element: 'adType', value: '3'}
        ],validationRules:[
            {expr:'req'},
            {expr:'url'}
        ]},
        {name: 'rmURL', activeRules: [
            {expr: 'eq', element: 'adType', value: '4'}
        ]},
        {name: 'impressionTracking1', type: 'trackingPicker', value:{type:'impression', value:'ravi'}},
        {name: 'impressionTracking2', type: 'trackingPicker', value:{type:'impression'}},
        {name: 'clickTracking1', type: 'trackingPicker', value:{type:'click'}},
        {name: 'clickTracking2', type: 'trackingPicker', value:{type:'click'}},
        {name: 'trackingCode', type: 'trackingCode', validationRules:[{expr:'req'}], active:false},
        {name: 'login', type: 'submit', value: 'login', group: 'buttons'}
    ]);

    var formModel = new FormModel({
        id: 'test',
        elements: coll,
        action: '/someaction'
    });

    var view = new FormView({
        model: formModel
    });

    view.addToTypeViewIndex('trackingPicker', TrackingPickerView);
    view.addToTypeViewIndex('trackingCode', TrackingCodeView);

    $('#container').append(view.render().el);
    formModel.on('all', function () {
        console.log('-----------------------------', arguments);
    });
    formModel.on('elements:showPassword:change:value', function (model, value) {
        formModel.setElementAttribute('password', 'type', value ? 'text' : 'password')
    });


</script>

</body>
</html>